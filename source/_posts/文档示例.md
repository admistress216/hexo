---
title: 文档示例
date: 2018-07-05 14:41:19
categories: MD-Demo
---

# 示例文档
----------------

|  版本 | 更新日志|  日期 |  作者  |
| :---: | :---: | :---: | :---: |
|  1.0  | 初始版 |20170301| Demi |


###  技术实现

#### 接口改造(`syncTruckFromGSP`)

- 拆机逻辑

![拆机逻辑](http://img.yiqizou.com/268C4D95-2EEF-4C2B-BCCE-85367647ABD4.png)

- 换机逻辑(略)

#### GSP回传异常数(`syncTruckExceptionCallback`)

##### 增加回传参数

> orgroot、orgcode、serv_type、old_gpsno、old_truckid、old_truckno

##### 拆机

- old_gpsno、old_truck_id、old_truck_no必传
> code = 2001
> 拆机单数据不完整，流程终止

- 设备在G7S不存在
> code = 2002
> 设备xx在g7s不存在,流程终止(请手动同步该设备后重新提交)

- 车辆不存在
> code = 2003
> 车辆xx不存在，流程终止

- 绑定关系不正确
> code = 2004
> 车牌号xx与设备xx不存在绑定关系

##### 移机

- old_gpsno、old_truck_id、old_truck_no、truck_no必传
> code = 3001
> 移机单数据不完整，流程终止

- 验证车牌
> code = 3002
> 目标车牌号不符合规则，流程终止

- 旧车辆与旧设备绑定关系
> code = 3003
> 设备xx与车牌号xx绑定关系异常，流程终止

- 新车辆与设备关系
> code = 3004
> 目标车辆XX绑定关系异常，流程终止

- G7S建车失败
> code = 3005
> 建车失败：xxx

- `设备机构与车辆机构不一致(分发失败)`
> code = 3006
> 设备xx与车辆xx所属机构不一致，流程终止

##### 换机

- gpsno(`installing_gpsno`)、old_gpsno、old_truck_id、old_truck_no必传
> code = 4001
> 换机单数据不完整，流程终止

- 新设备在G7S不存在
> code = 4002
> 新设备xx在g7s不存在,流程终止(请手动同步该设备后重新提交)

- 新设备已经绑定了车辆
> code = 4003
> 新设备xx存在绑定关系，无法进行绑定

- 车辆在G7S不存在
> code = 4004
> 换机单车牌号错误，流程终止

- 车辆与旧设备绑定关系异常
> code = 4005
> 车牌号xx与设备xx绑定关系异常，流程终止

- 新设备与车辆机构不一致(分发失败)
> code = 4006
> 新设备XX与车辆XX所属机构不一致，流程终止

- `不能垮顶级机构换机`
> code = 4007
> 新设备机构xx与当前机构xx不一致，流程终止(不能垮顶级机构换机)

##### 绑定、解绑

- 解绑失败
> code = 400
> 解绑失败：XXXX

- 绑定失败
> code = 401
> 绑定失败：XXXX

- 操作成功
> code = 0
> 绑定成功

### 数据库改造

-  增加字段

```
ALTER TABLE `truck_truck_exp` ADD `orgcode` VARCHAR (30) AFTER `orgroot`;
ALTER TABLE `truck_truck_exp` ADD `params` text COMMENT '参数' AFTER `description`;
ALTER TABLE `truck_truck_exp` ADD `type` int(6) NOT NULL COMMENT '工单类型:2(拆机) 3(移机) 4(换机)' AFTER `code`;
ALTER TABLE `cat_truck`.`truck_truck_exp`  ADD INDEX  USING BTREE (`type`) comment '';

```

### 自动脚本

- 删除120天以前强绑定异常数据(每天一次)

```
0 0 * * *  http://*.truck.g7s.chinawayltd.com/service.php?method=truck.cronlist.job_deleteOldTruckExp  > /dev/null 2>&1
```
- 车辆同步(每分钟一次)

```
*/1 * * * * http://*.truck.g7s.chinawayltd.com/service.php?method=truck.cronlist.syncTruckFromGsp   > /dev/null 2>&1
```  